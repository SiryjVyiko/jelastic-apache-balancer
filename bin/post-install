#!/bin/bash -eu

ln -s /var/log/httpd/ logs

[ -f /etc/httpd/conf/httpd.conf ] && { cp -f /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf.OLD; }
[ -f /etc/httpd/conf/virtualhosts_http.conf ] && { cp -f /etc/httpd/conf/virtualhosts_http.conf /etc/httpd/conf/virtualhosts_http.conf.OLD; }
[ -f /etc/httpd/conf/virtualhosts_ajp.conf ] && { cp -f /etc/httpd/conf/virtualhosts_ajp.conf /etc/httpd/conf/virtualhosts_ajp.conf.OLD; }
[ -f /etc/httpd/conf/virtualhosts_jk.conf ] && { cp -f /etc/httpd/conf/virtualhosts_jk.conf /etc/httpd/conf/virtualhosts_jk.conf.OLD; }
[ -f /etc/httpd/conf.d/ssl.conf ] && { cp -f /etc/httpd/conf.d/ssl.conf /etc/httpd/conf.d/ssl.conf.OLD; }
[ -f /etc/httpd/conf.d/worker.properties ] && { cp -f /etc/httpd/conf.d/ssl.conf /etc/httpd/conf.d/worker.properties.OLD; }

cp -f /opt/repo/versions/2.4/httpd.conf /etc/httpd/conf/httpd.conf;
cp -f /opt/repo/versions/2.4/virtualhosts_http.conf /etc/httpd/conf/virtualhosts_http.conf;
cp -f /opt/repo/versions/2.4/virtualhosts_ajp.conf /etc/httpd/conf/virtualhosts_ajp.conf;
cp -f /opt/repo/versions/2.4/virtualhosts_jk.conf /etc/httpd/conf/virtualhosts_jk.conf;
cp -f /opt/repo/versions/2.4/ssl.conf /etc/httpd/conf.d/ssl.conf;
cp -f /opt/repo/versions/2.4/worker.properties /etc/httpd/conf/worker.properties;

/sbin/iptables -t nat -D PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080
/sbin/iptables -t nat -D PREROUTING -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8743
/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT
/sbin/iptables -I INPUT -p tcp --dport 8009 -j ACCEPT
/sbin/iptables -I INPUT -p tcp --dport 443 -j ACCEPT
