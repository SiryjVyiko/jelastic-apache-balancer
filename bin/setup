#!/bin/bash -eu

/sbin/iptables -t nat -D PREROUTING -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080
/sbin/iptables -t nat -D PREROUTING -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 8743
/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT
/sbin/iptables -I INPUT -p tcp --dport 8009 -j ACCEPT
/sbin/iptables -I INPUT -p tcp --dport 443 -j ACCEPT
/etc/init.d/iptables save

echo "jelastic ALL=(ALL) NOPASSWD: /usr/sbin/setcap" >> /etc/sudoers

sed -i '1 i\Include conf/virtualhosts.conf\n' /etc/httpd/conf/httpd.conf
sed -i '2 i\#LoadModule ssl_module modules/mod_ssl.so\n' /etc/httpd/conf/httpd.conf
sed -i '/Listen 80/a Listen 8009\n' /etc/httpd/conf/httpd.conf

mv /opt/repo/virtualhosts.conf /etc/httpd/conf/virtualhosts.conf
mv /opt/repo/mod_jk.so /usr/lib64/httpd/modules/mod_jk.so
mv /opt/repo/ssl.conf /etc/httpd/conf.d/ssl.conf

ln -s /var/log/httpd/ logs
